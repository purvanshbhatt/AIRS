rules_version = '2';

// ╔═══════════════════════════════════════════════════════════════════════════╗
// ║  ResilAI Firestore Security Rules — ABAC (Attribute-Based Access Control) ║
// ║                                                                           ║
// ║  ARCHITECTURE:                                                            ║
// ║  • Frontend NEVER writes directly to Firestore                            ║
// ║  • All writes go through backend API (FastAPI + service account)          ║
// ║  • Frontend reads require authentication + org_id claim                   ║
// ║                                                                           ║
// ║  MULTI-TENANT STRUCTURE:                                                  ║
// ║  organizations/{orgId}/                                                   ║
// ║    ├── assessments/{assessmentId}                                         ║
// ║    ├── audit_events/{eventId}                                             ║
// ║    ├── tech_stack/{itemId}                                                ║
// ║    ├── findings/{findingId}                                               ║
// ║    └── evidence/{evidenceId}                                              ║
// ╚═══════════════════════════════════════════════════════════════════════════╝

service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════════════

    // Check if user is authenticated via Firebase Auth
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user's org_id claim matches the requested organization
    // The org_id is set in the Firebase custom claims by the backend
    function isOrgMember(orgId) {
      return request.auth.token.org_id == orgId;
    }

    // Check if user has admin claim for the organization
    function isOrgAdmin(orgId) {
      return request.auth.token.org_id == orgId 
          && request.auth.token.org_role == 'admin';
    }

    // Check if request is from backend service account
    // Service accounts have the 'service_account' claim set to true
    function isServiceAccount() {
      return request.auth.token.service_account == true;
    }

    // Validate required fields exist on document
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Validate timestamps are proper Firestore timestamps or ISO strings
    function isValidTimestamp(field) {
      return request.resource.data[field] is timestamp 
          || request.resource.data[field] is string;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // ORGANIZATION-LEVEL RULES
    // ═══════════════════════════════════════════════════════════════════════

    // Top-level organizations collection
    match /organizations/{orgId} {
      // READ: Authenticated users can read their own organization
      allow read: if isAuthenticated() && isOrgMember(orgId);
      
      // WRITE: ONLY backend service account can write
      // Frontend NEVER writes organization data directly
      allow write: if false;

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: assessments
      // ═════════════════════════════════════════════════════════════════════
      match /assessments/{assessmentId} {
        // READ: Org members can read their organization's assessments
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: audit_events (Audit Calendar)
      // ═════════════════════════════════════════════════════════════════════
      match /audit_events/{eventId} {
        // READ: Org members can read their audit calendar
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: tech_stack
      // ═════════════════════════════════════════════════════════════════════
      match /tech_stack/{itemId} {
        // READ: Org members can read tech stack items
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: findings
      // ═════════════════════════════════════════════════════════════════════
      match /findings/{findingId} {
        // READ: Org members can read findings
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: evidence
      // ═════════════════════════════════════════════════════════════════════
      match /evidence/{evidenceId} {
        // READ: Org members can read evidence
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: reports
      // ═════════════════════════════════════════════════════════════════════
      match /reports/{reportId} {
        // READ: Org members can read reports
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // SUB-COLLECTION: integrations
      // ═════════════════════════════════════════════════════════════════════
      match /integrations/{integrationId} {
        // READ: Org admins only (sensitive API keys)
        allow read: if isAuthenticated() && isOrgAdmin(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }

      // ═════════════════════════════════════════════════════════════════════
      // CATCH-ALL: Any other sub-collections under organization
      // ═════════════════════════════════════════════════════════════════════
      match /{document=**} {
        // READ: Org members can read any nested document
        allow read: if isAuthenticated() && isOrgMember(orgId);
        
        // WRITE: Backend service account only
        allow write: if false;
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    // LEGACY TOP-LEVEL COLLECTIONS (for migration compatibility)
    // These will be deprecated once all data is migrated to sub-collections
    // ═══════════════════════════════════════════════════════════════════════

    // Legacy: assessments at root level
    match /assessments/{assessmentId} {
      allow read: if isAuthenticated() 
        && resource.data.organization_id != null
        && request.auth.token.org_id == resource.data.organization_id;
      allow write: if false;
    }

    // Legacy: audit_calendar at root level
    match /audit_calendar/{entryId} {
      allow read: if isAuthenticated()
        && resource.data.organization_id != null
        && request.auth.token.org_id == resource.data.organization_id;
      allow write: if false;
    }

    // Legacy: tech_stack at root level
    match /tech_stack/{itemId} {
      allow read: if isAuthenticated()
        && resource.data.organization_id != null
        && request.auth.token.org_id == resource.data.organization_id;
      allow write: if false;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // DEFAULT DENY
    // ═══════════════════════════════════════════════════════════════════════
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
