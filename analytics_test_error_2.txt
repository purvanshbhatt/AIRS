============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0
rootdir: P:\projects\AIRS
plugins: cov-7.0.0, mock-3.15.1, anyio-4.11.0
collected 2 items

app\tests\test_analytics_fix.py F.                                       [100%]

================================== FAILURES ===================================
___________________ test_analytics_generation_with_mapping ____________________

    def test_analytics_generation_with_mapping():
        """Test that analytics are generated correctly with ID mapping."""
        service = AssessmentService(MagicMock())
    
        # Create findings with question_ids that need mapping
        # tl_05 maps to TL-001 (High)
        # iv_02 maps to IV-001 (Critical)
    
        findings = [
            Finding(
                id="f1",
                title="Retention Gap",
                severity=Severity.HIGH,
                question_id="tl_05",
                domain_name="Telemetry",
                domain_id="telemetry_logging"
            ),
            Finding(
                id="f2",
                title="MFA Gap",
                severity=Severity.CRITICAL,
                question_id="iv_02",
                domain_name="Identity",
                domain_id="identity_visibility"
            )
        ]
    
        # Generate analytics
        analytics = service._build_analytics(findings)
    
        # Check that we have attack paths (IV-001 usually triggers paths)
        assert len(analytics["attack_paths"]) > 0
    
        # Check that gaps are categorized
        assert analytics["detection_gaps"]["total_gaps"] >= 0
        assert analytics["identity_gaps"]["total_gaps"] >= 0
    
        # Specifically check IV-001 is recognized in identity gaps if logic places it there
        # (Exact placement depends on analytics engine logic, but it shouldn't be empty if rules match)
    
        # Verify rule_id mapping happened implicitly by checking if attack paths reference known techniques
        # or simply by the fact that we got results (empty finding_data usually yields empty analytics)
>       assert analytics["top_risks"] is not None
               ^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'top_risks'

app\tests\test_analytics_fix.py:47: KeyError
============================== warnings summary ===============================
app\db\database.py:49
  P:\projects\AIRS\app\db\database.py:49: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

app\schemas\base.py:6
  P:\projects\AIRS\app\schemas\base.py:6: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class BaseSchema(BaseModel):

app\schemas\scoring.py:13
  P:\projects\AIRS\app\schemas\scoring.py:13: PydanticDeprecatedSince20: Using extra keyword arguments on `Field` is deprecated and will be removed. Use `json_schema_extra` instead. (Extra keys: 'example'). Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    answers: Dict[str, Any] = Field(

app\schemas\organization.py:38
  P:\projects\AIRS\app\schemas\organization.py:38: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrganizationResponse(OrganizationBase):

app\schemas\assessment.py:56
  P:\projects\AIRS\app\schemas\assessment.py:56: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AnswerResponse(BaseModel):

app\schemas\assessment.py:70
  P:\projects\AIRS\app\schemas\assessment.py:70: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ScoreResponse(BaseModel):

app\schemas\assessment.py:100
  P:\projects\AIRS\app\schemas\assessment.py:100: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FindingResponse(BaseModel):

app\schemas\assessment.py:144
  P:\projects\AIRS\app\schemas\assessment.py:144: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AssessmentResponse(BaseModel):

app\schemas\assessment.py:170
  P:\projects\AIRS\app\schemas\assessment.py:170: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AssessmentSummary(BaseModel):

app\schemas\report.py:91
  P:\projects\AIRS\app\schemas\report.py:91: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReportResponse(BaseModel):

app\schemas\roadmap.py:29
  P:\projects\AIRS\app\schemas\roadmap.py:29: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class RoadmapItemResponse(RoadmapItemBase):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED app/tests/test_analytics_fix.py::test_analytics_generation_with_mapping
================== 1 failed, 1 passed, 11 warnings in 0.21s ===================
